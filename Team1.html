<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Piano Puzzle</title>

  <!-- Real piano samples via Tone.js Sampler (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>

  <style>
    :root { --keyH: 28vh; --pianoPad: 12px; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:#fff;
      min-height:100svh;
      overflow:hidden;
      /* Brighter red/green soft stripes + glow */
      background:
        radial-gradient(900px 650px at 20% 10%, rgba(255,255,255,0.18), rgba(255,255,255,0) 60%),
        radial-gradient(900px 650px at 80% 20%, rgba(255,255,255,0.14), rgba(255,255,255,0) 62%),
        repeating-linear-gradient(
          135deg,
          rgba(255, 70, 90, 0.92) 0px,
          rgba(255, 70, 90, 0.92) 90px,
          rgba(50, 220, 140, 0.92) 90px,
          rgba(50, 220, 140, 0.92) 180px
        );
      position: relative;
    }

    /* Soft-edge stripe blend overlay (makes stripes less harsh) */
    body::before{
      content:"";
      position:fixed;
      inset:-30px;
      background:
        radial-gradient(1200px 900px at 30% 30%, rgba(255,255,255,0.12), rgba(255,255,255,0) 55%),
        radial-gradient(1200px 900px at 70% 60%, rgba(255,255,255,0.10), rgba(255,255,255,0) 58%),
        linear-gradient(135deg, rgba(255,255,255,0.08), rgba(0,0,0,0.06));
      filter: blur(10px);
      pointer-events:none;
      z-index:0;
    }

    /* Falling snow */
    .snow{ position:fixed; inset:0; pointer-events:none; opacity:0.95; z-index:1; }
    .flake{
      position:absolute; top:-10vh;
      width:6px; height:6px; border-radius:50%;
      background:rgba(255,255,255,0.95);
      box-shadow: 0 0 10px rgba(255,255,255,0.35);
      animation: fall linear infinite;
    }
    @keyframes fall { to { transform: translate3d(var(--dx), 115vh, 0); } }

    .wrap{
      min-height:100svh;
      display:flex; flex-direction:column;
      padding-bottom: calc(var(--keyH) + 24px);
      box-sizing:border-box;
      position: relative;
      z-index: 2;
    }

    .lyrics-area{
      flex:1;
      display:flex; align-items:center; justify-content:center;
      padding:18px; box-sizing:border-box;
    }
    .lyrics{
      width:min(900px, 94vw);
      background:rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.22);
      border-radius:22px;
      padding:20px 18px;
      font-size: clamp(26px, 3.8vw, 40px);
      font-weight: 900;
      line-height:1.22;
      letter-spacing:0.2px;
      white-space:pre-line;
      text-align:center;
      text-shadow:0 8px 20px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }

    /* Reveal screen */
    .done{
      display:none;
      flex:1;
      align-items:center; justify-content:center;
      padding:18px; box-sizing:border-box;
    }
    .card{
      width:min(900px, 94vw);
      background:rgba(0,0,0,0.20);
      border:1px solid rgba(255,255,255,0.22);
      border-radius:22px;
      padding:20px 18px;
      font-size: clamp(24px, 3.4vw, 38px);
      font-weight: 900;
      line-height:1.22;
      text-align:center;
      text-shadow:0 8px 20px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }

    /* Piano */
    .piano{
      position:fixed; left:0; right:0; bottom:0;
      padding:var(--pianoPad);
      background:rgba(8,8,10,0.70);
      backdrop-filter: blur(12px);
      border-top:1px solid rgba(255,255,255,0.18);
      z-index: 3;
    }
    .piano-inner{
      max-width:980px;
      margin:0 auto;
      position:relative;
      height:var(--keyH);
    }
    .white-keys{
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap:6px;
      height:100%;
    }
    .white{
      position:relative;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.45);
      background: linear-gradient(#ffffff, #ececf2);
      user-select:none; -webkit-user-select:none;
      touch-action: manipulation;
      overflow:hidden;
    }

    .white.active-green{ outline:4px solid rgba(44,198,110,0.98); }
    .white.active-red{   outline:4px solid rgba(255,50,70,0.98); }

    /* Start indicator */
    .start-pulse{ animation: pulse 1.05s infinite; }
    @keyframes pulse{
      0%   { box-shadow: 0 0 0 0 rgba(44,198,110,0.0); }
      45%  { box-shadow: 0 0 0 12px rgba(44,198,110,0.26); }
      100% { box-shadow: 0 0 0 0 rgba(44,198,110,0.0); }
    }
    .start-arrow{
      position:absolute;
      top:-22px;
      left:50%;
      transform:translateX(-50%);
      width:0; height:0;
      border-left:10px solid transparent;
      border-right:10px solid transparent;
      border-bottom:18px solid rgba(44,198,110,0.98);
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.35));
      pointer-events:none;
    }

    /* Black keys (optional) */
    .black-keys{ position:absolute; left:0; right:0; top:0; height:60%; pointer-events:none; }
    .black{
      pointer-events:auto;
      position:absolute;
      width:10.5%;
      height:100%;
      border-radius:12px;
      background: linear-gradient(#2a2a2f, #0d0d10);
      border:1px solid rgba(255,255,255,0.12);
      user-select:none; -webkit-user-select:none;
      touch-action: manipulation;
    }
    .black.active-green{ outline:4px solid rgba(44,198,110,0.98); }
    .black.active-red{   outline:4px solid rgba(255,50,70,0.98); }
    .b-cs{ left:8.25%; } .b-ds{ left:20.75%; } .b-fs{ left:45.75%; } .b-gs{ left:58.25%; } .b-as{ left:70.75%; }
  </style>
</head>

<body>
  <div class="snow" id="snow"></div>

  <div class="wrap">
    <div class="lyrics-area" id="playScreen">
      <div class="lyrics">
______ _____, ______ _____, ______ ___ ___ ___
oh what fun it is to ride in a one horse open sleigh!
      </div>
    </div>

    <div class="done" id="doneScreen">
      <div class="card" id="clueText">TEAM 1 CLUE PLACEHOLDER</div>
    </div>
  </div>

  <div class="piano" id="pianoBar">
    <div class="piano-inner">
      <div class="white-keys">
        <div class="white" data-note="C4" onclick="press('C4')"></div>
        <div class="white" data-note="D4" onclick="press('D4')"></div>
        <div class="white" data-note="E4" onclick="press('E4')"></div>
        <div class="white" data-note="F4" onclick="press('F4')"></div>
        <div class="white" data-note="G4" onclick="press('G4')"></div>
        <div class="white" data-note="A4" onclick="press('A4')"></div>
        <div class="white" data-note="B4" onclick="press('B4')"></div>
        <div class="white" data-note="C5" onclick="press('C5')"></div>
      </div>

      <div class="black-keys">
        <div class="black b-cs" data-note="C#4" onclick="press('C#4')"></div>
        <div class="black b-ds" data-note="D#4" onclick="press('D#4')"></div>
        <div class="black b-fs" data-note="F#4" onclick="press('F#4')"></div>
        <div class="black b-gs" data-note="G#4" onclick="press('G#4')"></div>
        <div class="black b-as" data-note="A#4" onclick="press('A#4')"></div>
      </div>
    </div>
  </div>

<script>
  // ====== Put your real revealed clue here later ======
  document.getElementById("clueText").textContent =
    "TEAM 1 CLUE PLACEHOLDER — replace with your next location/clue text.";

  // ====== Jingle Bells opening (11 notes) ======
  // E E E | E E E | E G C D E
  const TARGET = ["E4","E4","E4","E4","E4","E4","E4","G4","C4","D4","E4"];

  // ====== Snow ======
  (function makeSnow(){
    const snow = document.getElementById("snow");
    const flakes = 36;
    for (let i = 0; i < flakes; i++) {
      const f = document.createElement("div");
      f.className = "flake";
      const left = Math.random() * 100;
      const size = 3 + Math.random() * 7;
      const dur  = 6 + Math.random() * 8;
      const dx   = (Math.random() * 60 - 30) + "vw";
      const delay = (-Math.random() * dur) + "s";
      f.style.left = left + "vw";
      f.style.width = size + "px";
      f.style.height = size + "px";
      f.style.setProperty("--dx", dx);
      f.style.animationDuration = dur + "s";
      f.style.animationDelay = delay;
      f.style.opacity = (0.35 + Math.random() * 0.60).toFixed(2);
      snow.appendChild(f);
    }
  })();

  // ====== Audio: Real samples with a NO-WAIT failsafe fallback ======
  // Key rule: never block audio. If samples aren't ready quickly, play a soft fallback tone immediately.

  // Fallback tone (soft, quick)
  let fallbackCtx = null;
  const freq = {
    "C4":261.63,"C#4":277.18,"D4":293.66,"D#4":311.13,"E4":329.63,"F4":349.23,"F#4":369.99,
    "G4":392.00,"G#4":415.30,"A4":440.00,"A#4":466.16,"B4":493.88,"C5":523.25
  };

  function fallbackTone(note, ms=150) {
    const ac = fallbackCtx || new (window.AudioContext || window.webkitAudioContext)();
    fallbackCtx = ac;
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = "triangle";
    o.frequency.value = freq[note] ?? 440;
    const now = ac.currentTime;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.12, now + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now + ms/1000);
    o.connect(g); g.connect(ac.destination);
    o.start(now);
    o.stop(now + ms/1000 + 0.03);
  }

  // Sampler (real-ish piano samples)
  let sampler = null;
  let samplerReady = false;
  let started = false;
  let loadKickoff = false;

  function kickoffLoadSampler() {
    if (loadKickoff) return;
    loadKickoff = true;

    // Start loading in the background (but don't block UX)
    (async () => {
      try {
        await Tone.start(); // iOS requires user gesture; our first press() calls playNote() which calls this
        sampler = new Tone.Sampler({
          urls: { "C4":"C4.mp3", "E4":"E4.mp3", "G4":"G4.mp3", "C5":"C5.mp3" },
          release: 0.9,
          baseUrl: "https://tonejs.github.io/audio/salamander/"
        }).toDestination();

        await Tone.loaded();
        sampler.volume.value = -7;
        samplerReady = true;
      } catch (e) {
        samplerReady = false;
      }
    })();
  }

  // Play note with a "deadline": if sampler isn't ready quickly, use fallback immediately.
  async function playNote(note) {
    // First tap: start sampler loading (non-blocking)
    kickoffLoadSampler();

    // If sampler is ready, use it.
    if (samplerReady && sampler) {
      try { sampler.triggerAttackRelease(note, "8n"); return; } catch (_) {}
    }

    // If not ready, DON'T wait—play fallback immediately.
    fallbackTone(note);

    // Also try to start Tone on first gesture (helps sampler load succeed)
    if (!started) {
      started = true;
      try { await Tone.start(); } catch (_) {}
    }
  }

  // ====== UI helpers ======
  let i = 0;

  function keyEl(note) {
    return document.querySelector(`[data-note="${CSS.escape(note)}"]`);
  }

  function setStartIndicator(note) {
    // clear prior indicators
    document.querySelectorAll(".start-arrow").forEach(x => x.remove());
    document.querySelectorAll(".start-pulse").forEach(x => x.classList.remove("start-pulse"));

    const el = keyEl(note);
    if (!el) return;

    // Keep it visibly green until first correct press
    el.classList.add("active-green");
    el.classList.add("start-pulse");

    const arrow = document.createElement("div");
    arrow.className = "start-arrow";
    el.appendChild(arrow);
  }

  function clearStartIndicator(note) {
    const el = keyEl(note);
    if (!el) return;
    el.classList.remove("active-green", "start-pulse");
    const arrow = el.querySelector(".start-arrow");
    if (arrow) arrow.remove();
  }

  // Start key highlighted immediately
  setStartIndicator(TARGET[0]);

  function blink(note, cls, times=3, interval=140) {
    const el = keyEl(note);
    if (!el) return;
    let t = 0;
    const id = setInterval(() => {
      el.classList.toggle(cls);
      t++;
      if (t >= times * 2) {
        el.classList.remove(cls);
        clearInterval(id);
      }
    }, interval);
  }

  async function press(note) {
    await playNote(note);

    const expected = TARGET[i];

    if (note === expected) {
      // First correct press: remove persistent start highlight/arrow/pulse
      if (i === 0) clearStartIndicator(TARGET[0]);

      // quick confirmation
      const el = keyEl(note);
      if (el) {
        el.classList.add("active-green");
        setTimeout(() => el.classList.remove("active-green"), 160);
      }

      i++;
      if (i >= TARGET.length) unlock();
      return;
    }

    // Wrong: blink both a few times, then hard reset
    blink(note, "active-red", 3, 140);
    blink(expected, "active-green", 3, 140);

    i = 0;
    setTimeout(() => setStartIndicator(TARGET[0]), 520);
  }

  function unlock() {
    document.getElementById("playScreen").style.display = "none";
    document.getElementById("doneScreen").style.display = "flex";
    document.getElementById("pianoBar").style.display = "none";
  }
</script>
</body>
</html>
